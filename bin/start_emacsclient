#!/bin/bash -eu

# usage: $0 [ FILE [ ... ] ]
#
# Run emacsclient, or run emacs if env variable "EMACS_SERVER_NAME" was not found.
# Command options is delegated to emacsclient. see `man emacsclient`.

if [ -z "$EMACS_SERVER_NAME" ]
then
    echo "Not defined a env variable: EMACS_SERVER_NAME" >&2
    return 1
fi

if ! emacsclient --socket-name "$EMACS_SERVER_NAME" --eval "server-name" \
    > /dev/null 2>&1
then
    echo "Do not found a socket: $EMACS_SERVER_NAME"

    if [ -z "$DISPLAY" ] && [ -z "$STY" ]
    then
        emacs "$@"
        exit $?
    fi

    echo "Create a new emacs server"

    init_script="--eval '(setq server-name \"$EMACS_SERVER_NAME\")'"
    init_script=$init_script" --eval '(server-start)'"
    if [ -n "$DISPLAY" ]
    then (eval emacs $init_script & disown) > /dev/null 2>&1
    elif [ -n "$STY" ]
    then eval screen emacs $init_script
    fi
fi

if [ $# -eq 0 ]
then
    echo "On $EMACS_SERVER_NAME"
    exit 0
fi

echo "Open \"$@\" on $EMACS_SERVER_NAME"

count=20
while [ $count -ne 0 ] &&\
              ! (emacsclient --socket-name "$EMACS_SERVER_NAME" "$@") > /dev/null 2>&1
do
    sleep 0.5
    count=$((count - 1))
done

if [ $count -eq 0 ]
then
    echo "ERROR: emacsclient timeout"
    exit 1
fi
